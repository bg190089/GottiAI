<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Margotti AI</title>
<link href="https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
:root{
  --bg:#080d18;--surf:#0d1426;--card:#111b30;--card2:#162038;
  --bdr:rgba(99,140,255,.1);--bdr2:rgba(99,140,255,.22);
  --txt:#dce8ff;--mut:#5a6e99;--mut2:#8098cc;
  --blue:#4f8ef7;--blue2:#7eb3ff;--bdim:rgba(79,142,247,.13);
  --grn:#34d399;--gdim:rgba(52,211,153,.13);
  --red:#f87171;--rdim:rgba(248,113,113,.13);
  --amb:#fbbf24;--pur:#7c3aed;--r:10px;
}
*{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;overflow:hidden;}
body{font-family:'Sora',sans-serif;background:var(--bg);color:var(--txt);font-size:13px;}

/* HEADER */
.hdr{height:52px;display:flex;align-items:center;justify-content:space-between;
  padding:0 16px;background:var(--surf);border-bottom:1px solid var(--bdr);flex-shrink:0;}
.logo{font-size:17px;font-weight:700;letter-spacing:-.5px;}
.logo span{color:var(--blue2);}
.logo b{color:var(--txt);}
.hdr-r{display:flex;align-items:center;gap:8px;}
.nav{display:flex;gap:2px;background:var(--card);border:1px solid var(--bdr);border-radius:8px;padding:3px;}
.ntab{padding:5px 14px;border-radius:6px;font-size:11px;font-weight:600;cursor:pointer;
  border:none;background:transparent;color:var(--mut);font-family:inherit;transition:all .2s;white-space:nowrap;}
.ntab.on{background:var(--blue);color:#fff;}
.apill{display:flex;align-items:center;gap:6px;padding:6px 12px;background:var(--card);
  border:1px solid var(--bdr2);border-radius:8px;color:var(--mut2);font-size:11px;
  font-weight:600;cursor:pointer;font-family:inherit;}
.dot{width:7px;height:7px;border-radius:50%;background:var(--mut);flex-shrink:0;}
.dot.on{background:var(--grn);box-shadow:0 0 8px var(--grn);}

/* EXAM BAR â€” lista flat sem separador */
.ebar{height:52px;display:flex;align-items:center;gap:5px;padding:0 14px;
  background:var(--surf);border-bottom:1px solid var(--bdr);
  overflow-x:auto;overflow-y:hidden;scrollbar-width:none;flex-shrink:0;}
.ebar::-webkit-scrollbar{display:none;}
.echip{display:flex;align-items:center;gap:5px;padding:5px 12px;border-radius:18px;
  border:1px solid var(--bdr2);background:transparent;color:var(--mut2);font-size:11px;
  font-weight:500;cursor:pointer;font-family:inherit;white-space:nowrap;
  transition:all .18s;flex-shrink:0;}
.echip:hover{background:var(--bdim);color:var(--blue2);}
.echip.on{background:var(--blue);border-color:var(--blue);color:#fff;font-weight:600;}

/* LAYOUT */
.main{display:flex;flex-direction:column;height:calc(100vh - 104px);overflow:hidden;}
.editor{display:flex;flex:1;overflow:hidden;min-height:0;}

/* INPUT PANEL */
.ipanel{width:280px;flex-shrink:0;border-right:1px solid var(--bdr);
  display:flex;flex-direction:column;padding:12px;gap:9px;overflow-y:auto;}

/* PACIENTE */
.pac-box{background:var(--card);border:1px solid var(--bdr2);border-radius:10px;padding:10px;
  display:flex;flex-direction:column;gap:7px;}
.pac-title{font-size:9px;font-weight:700;letter-spacing:1.2px;text-transform:uppercase;color:var(--mut);}
.pac-row{display:flex;gap:6px;}
.pac-field{display:flex;flex-direction:column;gap:3px;flex:1;min-width:0;}
.pac-lbl{font-size:9px;font-weight:600;color:var(--mut);text-transform:uppercase;letter-spacing:.8px;}
.pac-inp{width:100%;padding:6px 9px;border-radius:7px;background:var(--card2);
  border:1px solid var(--bdr2);color:var(--txt);font-size:12px;font-family:inherit;
  outline:none;transition:border-color .2s;}
.pac-inp:focus{border-color:var(--blue);}
.pac-inp::placeholder{color:var(--mut);}

/* INPUT UNIFICADO */
.input-box{background:var(--card);border:1px solid var(--bdr2);border-radius:10px;
  display:flex;flex-direction:column;transition:border-color .2s;}
.input-box:focus-within{border-color:var(--blue);}
.input-top{display:flex;align-items:flex-start;}
.iarea{flex:1;padding:10px 12px;border:none;outline:none;resize:none;background:transparent;
  color:var(--txt);font-family:'Sora',sans-serif;font-size:12px;line-height:1.6;}
.iarea::placeholder{color:var(--mut);}
.vozbtn{width:34px;height:34px;margin:7px 7px 0 0;border-radius:8px;border:1px solid var(--bdr2);
  background:transparent;color:var(--mut2);font-size:14px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;transition:all .2s;flex-shrink:0;}
.vozbtn:hover{background:var(--bdim);border-color:var(--blue);}
.vozbtn.live{background:var(--rdim);border-color:var(--red);color:var(--red);
  animation:pulse 1.5s infinite;}
@keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(248,113,113,.4);}50%{box-shadow:0 0 0 8px rgba(248,113,113,0);}}
.input-bottom{border-top:1px solid var(--bdr);padding:7px 10px;
  display:flex;align-items:center;gap:7px;}
.attach-btn{display:flex;align-items:center;gap:5px;padding:4px 10px;border-radius:7px;
  border:1px solid var(--bdr2);background:transparent;color:var(--mut2);font-size:11px;
  font-weight:600;cursor:pointer;font-family:inherit;transition:all .2s;white-space:nowrap;}
.attach-btn:hover{background:var(--bdim);border-color:var(--blue);color:var(--blue2);}
.attach-ct{background:var(--blue);color:#fff;font-size:9px;font-weight:700;
  padding:1px 5px;border-radius:8px;font-family:'JetBrains Mono',monospace;}
.clr-btn{margin-left:auto;padding:3px 8px;border-radius:5px;background:transparent;
  border:1px solid var(--bdr);color:var(--mut);font-size:10px;cursor:pointer;
  font-family:inherit;transition:all .15s;}
.clr-btn:hover{color:var(--red);border-color:var(--red);}

/* THUMBNAILS */
.thumbs{display:flex;gap:5px;flex-wrap:wrap;padding:0 10px 8px;}
.thumb{position:relative;width:52px;height:52px;border-radius:7px;overflow:hidden;
  border:1px solid var(--bdr2);background:var(--card2);
  display:flex;align-items:center;justify-content:center;font-size:18px;}
.thumb img{width:100%;height:100%;object-fit:cover;}
.thumb-del{position:absolute;top:2px;right:2px;width:16px;height:16px;border-radius:50%;
  background:rgba(0,0,0,.8);border:none;color:#fff;font-size:9px;cursor:pointer;
  display:flex;align-items:center;justify-content:center;}
.thumb-name{position:absolute;bottom:0;left:0;right:0;font-size:8px;color:#fff;
  background:rgba(0,0,0,.7);padding:2px 3px;text-align:center;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

/* RAG */
.rag-pill{display:none;align-items:center;gap:5px;padding:5px 10px;border-radius:7px;
  background:var(--gdim);border:1px solid rgba(52,211,153,.25);font-size:10px;font-weight:600;color:var(--grn);}
.rag-pill.show{display:flex;}

/* BOTÃ•ES */
.gbtn{width:100%;padding:12px;border-radius:10px;
  background:linear-gradient(135deg,var(--blue),#6366f1);border:none;color:#fff;
  font-size:13px;font-weight:700;cursor:pointer;font-family:inherit;
  transition:all .2s;box-shadow:0 4px 18px rgba(79,142,247,.3);}
.gbtn:hover:not(:disabled){transform:translateY(-1px);box-shadow:0 6px 24px rgba(79,142,247,.45);}
.gbtn:disabled{opacity:.5;cursor:not-allowed;transform:none !important;}
.mbtn-gen{width:100%;padding:11px;border-radius:10px;
  background:linear-gradient(135deg,#7c3aed,#4f46e5);border:none;color:#fff;
  font-size:13px;font-weight:700;cursor:pointer;font-family:inherit;
  transition:all .2s;box-shadow:0 4px 18px rgba(124,58,237,.28);}
.mbtn-gen:hover:not(:disabled){transform:translateY(-1px);}
.mbtn-gen:disabled{opacity:.5;cursor:not-allowed;transform:none !important;}

/* LAUDO */
.lpanel{flex:1;display:flex;flex-direction:column;overflow:hidden;min-width:0;}
.ltbar{display:flex;align-items:center;justify-content:space-between;
  padding:9px 14px;border-bottom:1px solid var(--bdr);flex-shrink:0;flex-wrap:wrap;gap:6px;}
.ltlbl{font-size:10px;font-weight:700;letter-spacing:1.2px;color:var(--mut);text-transform:uppercase;}
.lacts{display:flex;gap:5px;flex-wrap:wrap;}
.abtn{padding:5px 10px;border-radius:7px;font-size:11px;font-weight:600;cursor:pointer;
  border:1px solid var(--bdr2);background:var(--card);color:var(--mut2);
  transition:all .2s;font-family:inherit;}
.abtn:hover{border-color:var(--blue);color:var(--blue2);}
.abtn.sv{background:var(--gdim);border-color:rgba(52,211,153,.3);color:var(--grn);}
.abtn.sv:hover{background:var(--grn);color:#000;}
#lempty{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;}
.eico{font-size:44px;opacity:.12;}
.etxt{font-size:13px;text-align:center;line-height:1.9;color:var(--mut);}
#lta{flex:1;width:100%;border:none;outline:none;resize:none;background:var(--bg);
  color:var(--txt);font-family:'JetBrains Mono',monospace;font-size:13px;
  line-height:1.9;padding:20px 24px;overflow-y:auto;}
.mltab{padding:5px 12px;border-radius:16px;font-size:11px;font-weight:600;cursor:pointer;
  border:1px solid var(--bdr2);background:var(--card);color:var(--mut2);
  font-family:inherit;transition:all .2s;white-space:nowrap;}
.mltab.on{background:linear-gradient(135deg,#7c3aed,#4f46e5);border-color:#7c3aed;color:#fff;}

/* BANCO */
.banco{border-top:1px solid var(--bdr);flex-shrink:0;display:flex;flex-direction:column;
  height:200px;transition:height .25s;}
.banco.col{height:40px;overflow:hidden;}
.bhdr{display:flex;align-items:center;justify-content:space-between;height:40px;
  padding:0 14px;cursor:pointer;background:var(--surf);flex-shrink:0;}
.btitle{font-size:12px;font-weight:600;}
.bbadge{background:var(--bdim);color:var(--blue2);font-size:10px;font-weight:700;
  padding:2px 8px;border-radius:10px;font-family:'JetBrains Mono',monospace;}
.btog{font-size:11px;color:var(--mut);transition:transform .25s;}
.banco.col .btog{transform:rotate(180deg);}
.bbar{display:flex;align-items:center;gap:6px;padding:7px 14px;border-bottom:1px solid var(--bdr);flex-shrink:0;}
.bsearch{flex:1;padding:5px 10px;border-radius:7px;background:var(--card);
  border:1px solid var(--bdr2);color:var(--txt);font-size:11px;font-family:inherit;
  outline:none;transition:border-color .2s;min-width:80px;}
.bsearch:focus{border-color:var(--blue);}
.bsearch::placeholder{color:var(--mut);}
.bflt{padding:4px 11px;border-radius:14px;font-size:10px;font-weight:700;cursor:pointer;
  border:1px solid var(--bdr);background:transparent;color:var(--mut);font-family:inherit;transition:all .2s;}
.bflt.on{background:var(--bdim);border-color:rgba(79,142,247,.35);color:var(--blue2);}
.bcards{flex:1;overflow-x:auto;overflow-y:hidden;display:flex;gap:10px;
  padding:10px 14px;scrollbar-width:thin;scrollbar-color:var(--bdr2) transparent;}
.lcard{flex-shrink:0;width:210px;background:var(--card);border:1px solid var(--bdr);
  border-radius:var(--r);padding:11px;cursor:pointer;transition:border-color .18s;}
.lcard:hover{border-color:var(--blue);}
.lctop{display:flex;align-items:center;justify-content:space-between;margin-bottom:5px;}
.tag{font-size:9px;font-weight:700;padding:2px 7px;border-radius:10px;text-transform:uppercase;}
.tn{background:var(--gdim);color:var(--grn);}
.tp{background:var(--rdim);color:var(--red);}
.lcex{font-size:10px;color:var(--mut);font-family:'JetBrains Mono',monospace;margin-bottom:3px;}
.lcobs{font-size:10px;color:var(--amb);margin-bottom:3px;}
.lcprev{font-size:11px;color:var(--mut2);line-height:1.4;overflow:hidden;
  display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;margin-bottom:7px;}
.lcdt{font-size:9px;color:var(--mut);font-family:'JetBrains Mono',monospace;}
.lcbtns{display:flex;gap:4px;margin-top:7px;}
.lcbtn{flex:1;padding:4px;border-radius:6px;font-size:10px;font-weight:600;cursor:pointer;
  border:1px solid var(--bdr);background:transparent;color:var(--mut);font-family:inherit;transition:all .15s;}
.lcbtn:hover{background:var(--card2);color:var(--txt);}
.lcbtn.dl:hover{background:var(--rdim);border-color:rgba(248,113,113,.3);color:var(--red);}
.bempty{padding:20px;color:var(--mut);font-size:12px;text-align:center;line-height:1.8;}

/* DASHBOARD */
.dashpage{display:none;flex:1;overflow-y:auto;padding:20px 24px;}
.dash-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px;}
.dcard{background:var(--card);border:1px solid var(--bdr);border-radius:12px;padding:16px;}
.dcard-val{font-size:28px;font-weight:700;font-family:'JetBrains Mono',monospace;margin-bottom:2px;}
.dcard-lbl{font-size:11px;color:var(--mut);font-weight:600;}
.dcard.blue .dcard-val{color:var(--blue2);}
.dcard.grn  .dcard-val{color:var(--grn);}
.dcard.red  .dcard-val{color:var(--red);}
.dcard.amb  .dcard-val{color:var(--amb);}
.charts-row{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;}
.chart-card{background:var(--card);border:1px solid var(--bdr);border-radius:12px;padding:16px;}
.chart-card.full{grid-column:1/-1;}
.chart-title{font-size:12px;font-weight:700;color:var(--mut2);margin-bottom:14px;
  text-transform:uppercase;letter-spacing:.8px;}
.chart-wrap{position:relative;height:200px;}
.top-list{display:flex;flex-direction:column;gap:8px;}
.top-item{display:flex;align-items:center;gap:10px;}
.top-lbl{font-size:11px;color:var(--mut2);width:140px;flex-shrink:0;
  white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.top-bar-wrap{flex:1;height:8px;background:var(--card2);border-radius:4px;overflow:hidden;}
.top-bar{height:100%;background:var(--blue);border-radius:4px;transition:width .6s;}
.top-val{font-size:11px;font-weight:700;font-family:'JetBrains Mono',monospace;
  color:var(--blue2);width:28px;text-align:right;flex-shrink:0;}

/* CONFIG */
.cfgpage{display:none;flex:1;overflow-y:auto;padding:24px;}
.ccard{background:var(--card);border:1px solid var(--bdr);border-radius:14px;
  padding:20px;margin-bottom:16px;max-width:640px;}
.cctitle{font-size:14px;font-weight:700;margin-bottom:4px;}
.ccsub{font-size:12px;color:var(--mut);margin-bottom:16px;line-height:1.6;}
.flbl{font-size:11px;font-weight:600;color:var(--mut2);margin-bottom:5px;display:block;}
.finp{width:100%;padding:9px 12px;border-radius:8px;background:var(--card2);
  border:1px solid var(--bdr2);color:var(--txt);font-size:13px;font-family:inherit;outline:none;}
.finp:focus{border-color:var(--blue);}
.fsel{width:100%;padding:9px 12px;border-radius:8px;background:var(--card2);
  border:1px solid var(--bdr2);color:var(--txt);font-size:13px;font-family:inherit;outline:none;cursor:pointer;}
.fld{margin-bottom:12px;}
.pilist{display:flex;flex-direction:column;gap:6px;}
.piitem{display:flex;align-items:flex-start;gap:8px;padding:10px;
  background:var(--card2);border:1px solid var(--bdr);border-radius:8px;}
.pitxt{flex:1;font-size:12px;color:var(--mut2);line-height:1.5;}
.pitag{font-size:9px;padding:2px 7px;border-radius:4px;background:var(--bdim);
  color:var(--blue2);font-weight:700;white-space:nowrap;flex-shrink:0;}
.pidel{padding:4px 8px;border-radius:5px;background:transparent;border:1px solid var(--bdr);
  color:var(--mut);font-size:11px;cursor:pointer;font-family:inherit;transition:all .15s;flex-shrink:0;}
.pidel:hover{background:var(--rdim);border-color:var(--red);color:var(--red);}

/* MODAIS */
.ov{position:fixed;inset:0;background:rgba(0,0,0,.78);display:flex;align-items:center;
  justify-content:center;z-index:1000;padding:16px;}
.ov.off{display:none;}
.modal{background:var(--card);border:1px solid var(--bdr2);border-radius:16px;
  padding:24px;width:100%;max-width:380px;}
.mtitle{font-size:16px;font-weight:700;margin-bottom:4px;}
.msub{font-size:12px;color:var(--mut);margin-bottom:18px;line-height:1.6;}
.mbtns{display:flex;gap:8px;margin-top:18px;}
.mbtn{flex:1;padding:10px;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;
  border:1px solid var(--bdr2);background:var(--card2);color:var(--mut);font-family:inherit;transition:all .2s;}
.mbtn.pr{background:var(--blue);border-color:var(--blue);color:#fff;}
.mbtn.pr:hover{background:#3a78e0;}

/* TOAST */
.toast{position:fixed;bottom:20px;right:16px;z-index:9999;padding:10px 16px;
  border-radius:10px;font-size:12px;font-weight:600;max-width:calc(100vw - 32px);
  transform:translateY(60px);opacity:0;transition:all .3s;pointer-events:none;}
.toast.show{transform:translateY(0);opacity:1;}
.toast.ok{background:var(--grn);color:#000;}
.toast.err{background:var(--red);color:#fff;}
.toast.inf{background:var(--blue);color:#fff;}
.dots{display:inline-flex;gap:3px;align-items:center;}
.dots span{width:5px;height:5px;border-radius:50%;background:currentColor;animation:dd .8s infinite;}
.dots span:nth-child(2){animation-delay:.15s;}
.dots span:nth-child(3){animation-delay:.3s;}
@keyframes dd{0%,80%,100%{opacity:.3;transform:scale(.7);}40%{opacity:1;transform:scale(1);}}
::-webkit-scrollbar{width:3px;height:3px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--bdr2);border-radius:4px;}

/* MOBILE */
.mnav{display:none;position:fixed;bottom:0;left:0;right:0;background:var(--surf);
  border-top:1px solid var(--bdr);height:52px;z-index:100;}
.mntabs{display:flex;height:100%;}
.mntab{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:1px;font-size:9px;font-weight:600;color:var(--mut);cursor:pointer;border:none;
  background:transparent;font-family:inherit;}
.mntab.on{color:var(--blue2);}
.mntab .mi{font-size:17px;}
@media(max-width:768px){
  html,body{overflow:auto;height:auto;}
  .main{height:auto;overflow:visible;}
  .editor{flex-direction:column;}
  .ipanel{width:100%;border-right:none;border-bottom:1px solid var(--bdr);}
  .lpanel{min-height:55vh;}
  #lta{min-height:50vh;}
  .banco{height:auto;}
  .banco.col{height:40px;max-height:40px;overflow:hidden;}
  .bcards{flex-direction:column;overflow-x:hidden;overflow-y:auto;max-height:55vh;}
  .lcard{width:100%;}
  .nav{display:none;}
  .mnav{display:block;}
  body{padding-bottom:52px;}
  .dash-grid{grid-template-columns:repeat(2,1fr);}
  .charts-row{grid-template-columns:1fr;}
  .chart-card.full{grid-column:auto;}
  .dashpage{padding:14px;}
}
</style>
</head>
<body>

<!-- HEADER -->
<div class="hdr">
  <div class="logo"><span>Margotti</span><b>AI</b></div>
  <div class="hdr-r">
    <div class="nav">
      <button class="ntab on"  onclick="goTab('editor',this)">ğŸ“ Editor</button>
      <button class="ntab"     onclick="goTab('dash',this)">ğŸ“Š Dashboard</button>
      <button class="ntab"     onclick="goTab('config',this)">âš™ï¸ Config</button>
    </div>
    <button class="apill">
      <span class="dot on"></span><span>Claude</span>
    </button>
  </div>
</div>

<!-- EXAM BAR â€” todos os exames numa linha sÃ³, sem separador -->
<div class="ebar" id="ebar"></div>

<!-- MAIN -->
<div class="main" id="main">

  <!-- â•â• EDITOR â•â• -->
  <div class="editor" id="pg-editor">

    <!-- INPUT PANEL -->
    <div class="ipanel">

      <!-- DADOS DO PACIENTE -->
      <div class="pac-box">
        <div class="pac-title">ğŸ‘¤ Dados do Paciente</div>
        <div class="pac-field">
          <div class="pac-lbl">Nome</div>
          <input class="pac-inp" id="pac-nome" type="text" placeholder="Nome completo" autocomplete="off">
        </div>
        <div class="pac-row">
          <div class="pac-field">
            <div class="pac-lbl">Idade</div>
            <input class="pac-inp" id="pac-idade" type="text" placeholder="Ex: 45a">
          </div>
          <div class="pac-field">
            <div class="pac-lbl">Data</div>
            <input class="pac-inp" id="pac-data" type="date" style="color-scheme:dark;">
          </div>
        </div>
      </div>

      <!-- INPUT UNIFICADO: texto + voz + arquivos -->
      <div class="input-box">
        <div class="input-top">
          <textarea class="iarea" id="ti" rows="6"
            placeholder="Descreva os achados...&#10;&#10;Ex: hemangioma hepÃ¡tico 3,2x1,5cm&#10;Ex: cÃ¡lculo vesicular 8mm&#10;Ex: abdome normal"></textarea>
          <button class="vozbtn" id="vozbtn" onclick="toggleRec()" title="Gravar voz">ğŸ™ï¸</button>
        </div>

        <!-- Thumbnails dos arquivos anexados -->
        <div class="thumbs" id="thumbs" style="display:none;"></div>

        <div class="input-bottom">
          <button class="attach-btn" onclick="document.getElementById('fi').click()">
            ğŸ“ Anexar
            <span class="attach-ct" id="attach-ct" style="display:none;">0</span>
          </button>
          <input type="file" id="fi" accept="image/*,application/pdf" multiple
            style="display:none" onchange="onFiles(this)">
          <span style="font-size:10px;color:var(--mut);">JPG Â· PNG Â· PDF</span>
          <button class="clr-btn" onclick="clearAll()">âœ• Limpar</button>
        </div>
      </div>

      <div class="rag-pill" id="rag-pill">ğŸ¯ <span id="rag-txt">Base encontrada</span></div>

      <button class="gbtn" id="gbtn" onclick="generate()">âš¡ Gerar Laudo</button>
      <button class="mbtn-gen" id="mbtn" onclick="generateMulti()">ğŸ§© Multi-Laudo</button>
    </div>

    <!-- LAUDO PANEL -->
    <div class="lpanel">
      <div id="lempty">
        <div class="eico">ğŸ©»</div>
        <div class="etxt">Selecione o exame na barra acima,<br>insira os achados e clique em<br><strong>âš¡ Gerar Laudo</strong></div>
      </div>
      <div id="larea" style="display:none;flex:1;flex-direction:column;overflow:hidden;">
        <div class="ltbar">
          <div class="ltlbl">ğŸ“„ Laudo</div>
          <div class="lacts">
            <button class="abtn" onclick="copyL()">ğŸ“‹ Copiar</button>
            <button class="abtn" onclick="editL()">âœï¸ Editar</button>
            <button class="abtn" onclick="pdfL()">ğŸ“¥ PDF</button>
            <button class="abtn sv" onclick="openM('m-save')">ğŸ’¾ Salvar</button>
          </div>
        </div>
        <textarea id="lta" readonly placeholder="Laudo aparecerÃ¡ aqui..."></textarea>
      </div>
      <div id="mlarea" style="display:none;flex:1;flex-direction:column;overflow:hidden;">
        <div class="ltbar">
          <div class="ltlbl">ğŸ§© Multi-Laudo</div>
          <div id="mltabs" style="display:flex;gap:4px;flex-wrap:wrap;"></div>
          <div class="lacts">
            <button class="abtn" onclick="copyML()">ğŸ“‹ Copiar</button>
            <button class="abtn" onclick="pdfML()">ğŸ“¥ PDF</button>
            <button class="abtn sv" onclick="saveAll()">ğŸ’¾ Salvar Todos</button>
          </div>
        </div>
        <textarea id="mlta" readonly style="flex:1;width:100%;border:none;outline:none;resize:none;
          background:var(--bg);color:var(--txt);font-family:'JetBrains Mono',monospace;
          font-size:13px;line-height:1.9;padding:20px 24px;overflow-y:auto;"></textarea>
      </div>
    </div>

  </div><!-- /editor -->

  <!-- â•â• DASHBOARD â•â• -->
  <div class="dashpage" id="pg-dash">
    <div class="dash-grid">
      <div class="dcard blue"><div class="dcard-val" id="d-total">0</div><div class="dcard-lbl">ğŸ“‹ Total Laudos</div></div>
      <div class="dcard grn"> <div class="dcard-val" id="d-norm">0</div> <div class="dcard-lbl">âœ… Normais</div></div>
      <div class="dcard red"> <div class="dcard-val" id="d-pat">0</div>  <div class="dcard-lbl">âš ï¸ PatolÃ³gicos</div></div>
      <div class="dcard amb"> <div class="dcard-val" id="d-tipos">0</div><div class="dcard-lbl">ğŸ©» Tipos de Exame</div></div>
    </div>
    <div class="charts-row">
      <div class="chart-card">
        <div class="chart-title">Normal vs PatolÃ³gico</div>
        <div class="chart-wrap"><canvas id="chartDonut"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-title">Laudos por MÃªs</div>
        <div class="chart-wrap"><canvas id="chartLine"></canvas></div>
      </div>
      <div class="chart-card full">
        <div class="chart-title">Por Tipo de Exame</div>
        <div class="chart-wrap" style="height:180px;"><canvas id="chartBar"></canvas></div>
      </div>
    </div>
    <div class="chart-card" style="margin-bottom:16px;">
      <div class="chart-title">ğŸ† Ranking de Exames</div>
      <div class="top-list" id="toplist"></div>
    </div>
  </div>

  <!-- â•â• CONFIG â•â• -->
  <div class="cfgpage" id="pg-config">
    <div class="ccard">
      <div class="cctitle">ğŸ” InstruÃ§Ãµes Personalizadas</div>
      <div class="ccsub">Aplicadas em toda geraÃ§Ã£o. Salvas no Supabase â€” disponÃ­veis em qualquer dispositivo.<br>Senha: <code>margotti</code></div>
      <div id="lockform">
        <input class="finp" id="pwdinp" type="password" placeholder="Senha..."
          onkeydown="if(event.key==='Enter')unlock()">
        <button class="gbtn" onclick="unlock()" style="margin-top:10px;padding:10px;font-size:13px;">ğŸ”“ Desbloquear</button>
      </div>
      <div id="unlocked" style="display:none;">
        <div style="color:var(--grn);font-size:12px;margin-bottom:14px;">âœ… Painel desbloqueado</div>
        <div class="fld">
          <label class="flbl">Exame</label>
          <select class="fsel" id="pexam">
            <option value="geral">â­ Geral (todos os exames)</option>
            <option value="obstetrico">ğŸ¤° ObstÃ©trico</option>
            <option value="abdome">ğŸ«€ Abdome Total</option>
            <option value="endovaginal">ğŸ”¬ Endovaginal</option>
            <option value="tireoide">ğŸ¦‹ Tireoide</option>
            <option value="urinario">ğŸ’§ UrinÃ¡rio</option>
            <option value="mamas">ğŸ—ï¸ Mamas</option>
            <option value="vascular">ğŸ©¸ Vascular</option>
            <option value="prostata">ğŸ”µ PrÃ³stata</option>
            <option value="cervical">ğŸ”´ Cervical</option>
            <option value="partes_moles">ğŸŸ¡ Partes Moles</option>
            <option value="parede_abdominal">ğŸŸ¢ Parede Abdominal</option>
          </select>
        </div>
        <div class="fld">
          <label class="flbl">InstruÃ§Ã£o</label>
          <textarea class="finp" id="ptxt" rows="3" style="resize:vertical;"
            placeholder="Ex: Quando houver colelitÃ­ase, use a frase: VesÃ­cula biliar com imagem hiperecogÃªnica de ___ mm com sombra acÃºstica posterior..."></textarea>
        </div>
        <button class="gbtn" onclick="addPrompt()" style="padding:10px;font-size:13px;">â• Adicionar InstruÃ§Ã£o</button>
      </div>
    </div>
    <div class="ccard">
      <div class="cctitle">ğŸ“‹ InstruÃ§Ãµes Salvas</div>
      <div class="ccsub">Carregadas do Supabase em qualquer dispositivo</div>
      <div class="pilist" id="pilist"><div style="color:var(--mut);font-size:12px;">Nenhuma instruÃ§Ã£o salva.</div></div>
    </div>
  </div>

  <!-- BANCO -->
  <div class="banco col" id="banco">
    <div class="bhdr" onclick="toggleBanco()">
      <div style="display:flex;align-items:center;gap:8px;">
        <span>ğŸ—‚</span><span class="btitle">Banco de Laudos</span>
        <span class="bbadge" id="bct">0</span>
      </div>
      <div style="display:flex;align-items:center;gap:6px;" onclick="event.stopPropagation()">
        <input class="bsearch" id="bsearch" placeholder="ğŸ” Buscar..." oninput="renderBanco()">
        <button class="bflt on" data-f="todos"      onclick="filtB(this)">Todos</button>
        <button class="bflt"    data-f="normal"     onclick="filtB(this)">Normais</button>
        <button class="bflt"    data-f="patologico" onclick="filtB(this)">Patol.</button>
        <span class="btog">â–¼</span>
      </div>
    </div>
    <div class="bcards" id="bcards">
      <div class="bempty">Nenhum laudo ainda.<br>Gere e salve para construir seu banco.</div>
    </div>
  </div>

</div><!-- /main -->

<!-- MOBILE NAV -->
<div class="mnav">
  <div class="mntabs">
    <button class="mntab on" onclick="mNav('editor',this)"><span class="mi">ğŸ“</span>Editor</button>
    <button class="mntab"    onclick="mNav('dash',this)">  <span class="mi">ğŸ“Š</span>Stats</button>
    <button class="mntab"    onclick="mNav('banco',this)"> <span class="mi">ğŸ—‚</span>Banco</button>
    <button class="mntab"    onclick="mNav('config',this)"><span class="mi">âš™ï¸</span>Config</button>
  </div>
</div>

<!-- MODAL SALVAR -->
<div class="ov off" id="m-save">
  <div class="modal">
    <div class="mtitle">ğŸ’¾ Salvar no Banco</div>
    <div class="msub">O banco alimenta o aprendizado da IA nas prÃ³ximas geraÃ§Ãµes</div>
    <div class="fld">
      <label class="flbl">ClassificaÃ§Ã£o</label>
      <select class="fsel" id="scls">
        <option value="normal">âœ… Normal</option>
        <option value="patologico">âš ï¸ PatolÃ³gico</option>
      </select>
    </div>
    <div class="fld">
      <label class="flbl">ObservaÃ§Ã£o (ajuda a IA a encontrar)</label>
      <input class="finp" id="sobs" placeholder="Ex: hemangioma hepÃ¡tico, colelitÃ­ase 8mm...">
    </div>
    <div class="mbtns">
      <button class="mbtn" onclick="closeM('m-save')">Cancelar</button>
      <button class="mbtn pr" onclick="doSave()">ğŸ’¾ Salvar</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EXAMES â€” lista flat, vascular incluÃ­do, sem separador
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ALL_EXAMS = [
  {id:'obstetrico',       label:'ObstÃ©trico',           icon:'ğŸ¤°'},
  {id:'abdome',           label:'Abdome Total',          icon:'ğŸ«€'},
  {id:'endovaginal',      label:'Endovaginal',           icon:'ğŸ”¬'},
  {id:'tireoide',         label:'Tireoide c/ Doppler',   icon:'ğŸ¦‹'},
  {id:'urinario',         label:'Rins e Vias UrinÃ¡rias', icon:'ğŸ’§'},
  {id:'mamas',            label:'Mamas',                 icon:'ğŸ—ï¸'},
  {id:'vascular',         label:'Vascular',              icon:'ğŸ©¸'},
  {id:'prostata',         label:'PrÃ³stata',              icon:'ğŸ”µ'},
  {id:'cervical',         label:'Cervical',              icon:'ğŸ”´'},
  {id:'partes_moles',     label:'Partes Moles',          icon:'ğŸŸ¡'},
  {id:'parede_abdominal', label:'Parede Abdominal',      icon:'ğŸŸ¢'},
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TEMPLATES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TPL = {
obstetrico:`ULTRASSONOGRAFIA OBSTÃ‰TRICA

Feto Ãºnico em situaÃ§Ã£o longitudinal, apresentaÃ§Ã£o cefÃ¡lica, dorso Ã  direita/esquerda.
Batimentos cardÃ­acos fetais presentes. FC ___ bpm. Movimentos fetais presentes.

Biometria fetal:
D.B.P.: ___ cm.  CC: ___ cm.  FÃªmur: ___ cm.  CA: ___ cm.
Peso fetal estimado: ___ gramas (Percentil ___)

Placenta: parede anterior/posterior, grau ___.
LÃ­quido amniÃ³tico: volume normal, maior bolsÃ£o ___ cm.

IMPRESSÃƒO DIAGNÃ“STICA:
- GestaÃ§Ã£o de ___ semanas e ___ dias com vitalidade fetal preservada.

Dr. Roberto Freire Margotti | CRM-BA 26929 | RQE: 21367`,

abdome:`ULTRASSONOGRAFIA DO ABDOME TOTAL

FÃ­gado com dimensÃµes e forma normais, contornos regulares e ecotextura parenquimatosa homogÃªnea. As veias hepÃ¡ticas tÃªm configuraÃ§Ã£o anatÃ´mica e a porta tem calibre normal.
NÃ£o hÃ¡ dilataÃ§Ã£o das vias biliares intra ou extra-hepÃ¡ticas.
VesÃ­cula biliar distendida fisiologicamente, paredes finas, conteÃºdo anecoico, sem evidÃªncias de cÃ¡lculos.
PÃ¢ncreas com morfologia, contornos, dimensÃµes e ecotextura preservados.
BaÃ§o tÃ³pico, com dimensÃµes, contornos e ecotextura normais.
Rins tÃ³picos, com forma, contornos e dimensÃµes normais. ParÃªnquima com espessura e ecogenicidade preservadas. AusÃªncia de hidronefrose. Sem cÃ¡lculos renais evidentes.
Aorta e veia cava inferior com trajeto e calibre normais.
Bexiga em repleÃ§Ã£o fisiolÃ³gica, paredes finas, conteÃºdo anecoico.
AusÃªncia de lÃ­quido livre na cavidade abdominal.

IMPRESSÃƒO DIAGNÃ“STICA:
- Exame ecogrÃ¡fico normal.

Dr. Roberto Freire Margotti | CRM-BA 26929 | RQE: 21367`,

endovaginal:`ULTRASSONOGRAFIA ENDOVAGINAL

Ãštero em anteversoflexÃ£o, centrado, contornos regulares, ecotextura homogÃªnea.
Ãštero: ___ cm. Volume: ___ cmÂ³. EndomÃ©trio: ___ mm.

OvÃ¡rio direito: normal. Medidas: ___ cm. Volume: ___ cmÂ³.
OvÃ¡rio esquerdo: normal. Medidas: ___ cm. Volume: ___ cmÂ³.

AusÃªncia de lÃ­quido livre na pequena pelve.

IMPRESSÃƒO DIAGNÃ“STICA:
- Exame ecogrÃ¡fico normal.

Dr. Roberto Freire Margotti | CRM-BA 26929 | RQE: 21367`,

tireoide:`ULTRASSONOGRAFIA DE TIREÃ“IDE COM DOPPLER

Tecido glandular de volume preservado, contornos regulares, ecogenicidade e ecotextura homogÃªneas. Sem nÃ³dulos ou cistos detectÃ¡veis.

Lobo direito: ___ cm. Volume = ___ cmÂ³.
Lobo esquerdo: ___ cm. Volume = ___ cmÂ³.
Istmo: ___ cm. Volume global: ___ cmÂ³.

DOPPLERVELOCIMETRIA COLORIDA: padrÃ£o vascular habitual.
ATID: VPS ___ cm/s   ATIE: VPS ___ cm/s

CONCLUSÃƒO:
- Exame ecogrÃ¡fico normal.
- Estudo Doppler dentro dos limites da normalidade.

Dr. Roberto Freire Margotti | CRM-BA 26929 | RQE: 21367`,

urinario:`ULTRASSONOGRAFIA DO APARELHO URINÃRIO

Rim direito: tÃ³pico, normal. Eixo bipolar ___ cm. ParÃªnquima ___ cm. Sem hidronefrose. Sem cÃ¡lculos.
Rim esquerdo: tÃ³pico, normal. Eixo bipolar ___ cm. ParÃªnquima ___ cm. Sem hidronefrose. Sem cÃ¡lculos.

Bexiga em repleÃ§Ã£o, paredes finas, conteÃºdo anecoico.

IMPRESSÃƒO DIAGNÃ“STICA:
- Exame ecogrÃ¡fico sem achados patolÃ³gicos.

Dr. Roberto Freire Margotti | CRM-BA 26929 | RQE: 21367`,

mamas:`ULTRASSONOGRAFIA DAS MAMAS + AXILAS

Mamas com tecido glandular predominante e ecotextura normal.
NÃ£o se observam imagens nodulares sÃ³lidas ou cÃ­sticas.
Linfonodos axilares com forma, dimensÃµes e ecotextura normais.
RegiÃµes para-esternais e prolongamentos axilares livres.

IMPRESSÃƒO DIAGNÃ“STICA:
- Exame sem anormalidades ecogrÃ¡ficas (BI-RADS 1).

Dr. Roberto Freire Margotti | CRM-BA 26929 | RQE: 21367`,

vascular:`ULTRASSONOGRAFIA VASCULAR COM DOPPLER

ArtÃ©rias carÃ³tidas comuns, internas e externas bilaterais com fluxo laminar, paredes regulares, sem placas ateromatosas ou estenoses hemodinamicamente significativas ao Doppler colorido e pulsado.

CARÃ“TIDA DIREITA:
ACC: VPS ___ cm/s | IPS ___
ACI: VPS ___ cm/s | IPS ___
ACE: VPS ___ cm/s | IPS ___

CARÃ“TIDA ESQUERDA:
ACC: VPS ___ cm/s | IPS ___
ACI: VPS ___ cm/s | IPS ___
ACE: VPS ___ cm/s | IPS ___

ArtÃ©rias vertebrais com fluxo anterÃ³grado e velocidades dentro dos limites da normalidade bilateralmente.

IMPRESSÃƒO DIAGNÃ“STICA:
- Exame Doppler vascular sem alteraÃ§Ãµes hemodinamicamente significativas.

Dr. Roberto Freire Margotti | CRM-BA 26929 | RQE: 21367`,

prostata:`ULTRASSONOGRAFIA DA PRÃ“STATA

PrÃ³stata tÃ³pica, forma e contornos regulares.
DimensÃµes: ___ x ___ x ___ cm. Volume: ___ cmÂ³ (normal â‰¤ 30 cmÂ³).
Ecotextura homogÃªnea, sem nodulaÃ§Ãµes suspeitas.
VesÃ­culas seminais de aspecto normal.
Bexiga em repleÃ§Ã£o, paredes finas.
ResÃ­duo pÃ³s-miccional: ___ mL.

IMPRESSÃƒO DIAGNÃ“STICA:
- PrÃ³stata de volume ___, sem nodulaÃ§Ãµes suspeitas ao ultrassom.

Dr. Roberto Freire Margotti | CRM-BA 26929 | RQE: 21367`,

cervical:`ULTRASSONOGRAFIA DE REGIÃƒO CERVICAL

Partes moles cervicais sem alteraÃ§Ãµes ecogrÃ¡ficas.
Linfonodos submandibulares: aspecto normal, atÃ© ___ mm.
Linfonodos jugulares internos: sem linfonodomegalia.
Linfonodos supraclaviculares: sem alteraÃ§Ãµes.
GlÃ¢ndulas salivares: aspecto normal.
Vasos cervicais: carÃ³tidas e jugulares pÃ©rvias ao Doppler colorido.

IMPRESSÃƒO DIAGNÃ“STICA:
- Exame ecogrÃ¡fico de regiÃ£o cervical sem alteraÃ§Ãµes significativas.

Dr. Roberto Freire Margotti | CRM-BA 26929 | RQE: 21367`,

partes_moles:`ULTRASSONOGRAFIA DE PARTES MOLES

Local: ___ / Lado: ___

Planos superficiais com ecotextura preservada.
___ (achado â€” dimensÃµes, ecogenicidade, vascularizaÃ§Ã£o ao Doppler).
Estruturas adjacentes sem alteraÃ§Ãµes. Sem coleÃ§Ã£o ou hematoma.

IMPRESSÃƒO DIAGNÃ“STICA:
- ___ (conclusÃ£o).

Dr. Roberto Freire Margotti | CRM-BA 26929 | RQE: 21367`,

parede_abdominal:`ULTRASSONOGRAFIA DA PAREDE ABDOMINAL

RegiÃ£o: ___

Planos musculares e aponeurÃ³ticos de aspecto normal.
___ (achado: hÃ©rnia, coleÃ§Ã£o, nÃ³dulo â€” dimensÃµes, conteÃºdo, redutibilidade).

IMPRESSÃƒO DIAGNÃ“STICA:
- ___ (conclusÃ£o).

Dr. Roberto Freire Margotti | CRM-BA 26929 | RQE: 21367`,
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ESTADO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let curExam     = 'abdome';
let report      = '';
let bfilt       = 'todos';
let banco       = [];
let prompts     = [];
let fileList    = [];
let multiLaudos = [];
let multiActive = 0;
let recObj      = null;
let isRec       = false;
let charts      = {};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
buildEbar();
document.getElementById('pac-data').value = new Date().toISOString().split('T')[0];
loadBanco();
loadPrompts();

function buildEbar() {
  const bar  = document.getElementById('ebar');
  bar.innerHTML = ALL_EXAMS.map(e =>
    `<button class="echip${e.id===curExam?' on':''}" onclick="setExam('${e.id}',this)">
       <span style="font-size:13px">${e.icon}</span>${e.label}</button>`
  ).join('');
}

function setExam(id, btn) {
  curExam = id;
  document.querySelectorAll('.echip').forEach(b => b.classList.remove('on'));
  btn.classList.add('on');
  btn.scrollIntoView({behavior:'smooth', block:'nearest', inline:'center'});
  document.getElementById('rag-pill').classList.remove('show');
}

function getPaciente() {
  return {
    nome:  document.getElementById('pac-nome').value.trim(),
    idade: document.getElementById('pac-idade').value.trim(),
    data:  document.getElementById('pac-data').value
  };
}

function formatDataBR(iso) {
  if (!iso) return '';
  const [y, m, d] = iso.split('-');
  return d && m && y ? `${d}/${m}/${y}` : iso;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TABS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function goTab(t, btn) {
  document.querySelectorAll('.ntab').forEach(b => b.classList.remove('on'));
  btn.classList.add('on');
  document.getElementById('pg-editor').style.display = t==='editor' ? 'flex'  : 'none';
  document.getElementById('pg-dash').style.display   = t==='dash'   ? 'block' : 'none';
  document.getElementById('pg-config').style.display = t==='config' ? 'block' : 'none';
  document.getElementById('banco').style.display     = t==='editor' ? 'flex'  : 'none';
  if (t === 'dash') renderDash();
}

function mNav(t, btn) {
  document.querySelectorAll('.mntab').forEach(b => b.classList.remove('on'));
  btn.classList.add('on');
  ['pg-editor','pg-dash','pg-config','banco'].forEach(id =>
    document.getElementById(id).style.display = 'none');
  if (t === 'editor') {
    document.getElementById('pg-editor').style.display = 'flex';
    document.getElementById('banco').style.display     = 'flex';
  } else if (t === 'dash') {
    document.getElementById('pg-dash').style.display = 'block'; renderDash();
  } else if (t === 'banco') {
    document.getElementById('banco').style.display = 'flex';
    document.getElementById('banco').classList.remove('col');
  } else {
    document.getElementById('pg-config').style.display = 'block';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INPUT & ARQUIVOS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getInput() { return document.getElementById('ti').value.trim(); }

function clearAll() {
  document.getElementById('ti').value = '';
  fileList = [];
  renderThumbs();
  document.getElementById('rag-pill').classList.remove('show');
}

function onFiles(input) {
  const files = Array.from(input.files);
  if (!files.length) return;
  let loaded = 0;
  files.forEach(f => {
    if (fileList.find(x => x.name === f.name)) { loaded++; return; }
    const reader = new FileReader();
    reader.onload = e => {
      fileList.push({
        name:    f.name,
        base64:  e.target.result.split(',')[1],
        type:    f.type,
        preview: f.type.startsWith('image/') ? e.target.result : null
      });
      if (++loaded === files.length) {
        renderThumbs();
        toast(`${fileList.length} arquivo(s) pronto(s)`, 'ok');
      }
    };
    reader.readAsDataURL(f);
  });
  input.value = '';
}

function removeFile(idx) { fileList.splice(idx, 1); renderThumbs(); }

function renderThumbs() {
  const ct  = document.getElementById('attach-ct');
  const box = document.getElementById('thumbs');
  if (!fileList.length) {
    ct.style.display = 'none'; box.style.display = 'none'; box.innerHTML = ''; return;
  }
  ct.style.display  = 'inline';
  ct.textContent    = fileList.length;
  box.style.display = 'flex';
  box.innerHTML = fileList.map((f, i) => `
    <div class="thumb">
      ${f.preview
        ? `<img src="${f.preview}" alt="${f.name}">`
        : `<span>ğŸ“„</span><div class="thumb-name">${f.name}</div>`}
      <button class="thumb-del" onclick="removeFile(${i})">âœ•</button>
    </div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  VOZ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toggleRec() {
  const SR = window.webkitSpeechRecognition || window.SpeechRecognition;
  if (!SR) { toast('Use Chrome para gravaÃ§Ã£o de voz', 'err'); return; }
  const btn = document.getElementById('vozbtn');
  if (!isRec) {
    recObj = new SR();
    recObj.lang = 'pt-BR'; recObj.continuous = true; recObj.interimResults = true;
    recObj.onstart = () => {
      isRec = true; btn.classList.add('live');
      btn.textContent = 'â¹ï¸'; btn.title = 'Parar gravaÃ§Ã£o';
    };
    recObj.onresult = e => {
      let t = '';
      for (let i = e.resultIndex; i < e.results.length; i++)
        t += e.results[i][0].transcript;
      const ta = document.getElementById('ti');
      ta.value = (ta.value + ' ' + t).trimStart();
    };
    recObj.onerror = () => stopRec(btn);
    recObj.onend   = () => stopRec(btn);
    recObj.start();
  } else { recObj.stop(); }
}
function stopRec(btn) {
  isRec = false; btn.classList.remove('live');
  btn.textContent = 'ğŸ™ï¸'; btn.title = 'Gravar voz';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RAG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function ragSearch(query, exam) {
  try {
    const r = await fetch('/api/search', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({query, exam, limit:5})
    });
    if (!r.ok) return [];
    return (await r.json()).results || [];
  } catch { return []; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PROMPT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function buildPrompt(input, exam) {
  const similar = await ragSearch(input || 'normal', exam);
  const pill    = document.getElementById('rag-pill');

  let ragCtx = '';
  if (similar.length > 0) {
    pill.classList.add('show');
    document.getElementById('rag-txt').textContent =
      `${similar.length} laudo(s) similar(es) encontrado(s) no banco`;
    ragCtx  = '\n\nâ•â•â•â• LAUDOS DO DR. ROBERTO PARA REFERÃŠNCIA â•â•â•â•\n';
    ragCtx += 'Use o estilo, frases e padrÃ£o de conclusÃ£o EXATOS destes laudos.\n';
    ragCtx += 'Adapte APENAS os dados do novo paciente. NÃ£o invente medidas.\n\n';
    similar.forEach((l, i) => {
      const tipo = l.classification === 'patologico' ? 'âš ï¸ PATOLÃ“GICO' : 'âœ… NORMAL';
      const obs  = l.obs || l.observation || '';
      ragCtx += `[REFERÃŠNCIA ${i+1} | ${tipo}${obs ? ' | '+obs : ''}]\n`;
      ragCtx += l.report_text + '\n\n';
    });
    ragCtx += 'â•â•â•â• FIM DAS REFERÃŠNCIAS â•â•â•â•';
  } else {
    pill.classList.remove('show');
    ragCtx = '\n\n[Banco vazio para este exame â€” usando template padrÃ£o]';
  }

  const pts  = prompts.filter(p => p.exam === exam || p.exam === 'geral');
  const pStr = pts.length
    ? '\n\nINSTRUÃ‡Ã•ES FIXAS DO DR. ROBERTO:\n' + pts.map(p => '- ' + p.txt).join('\n')
    : '';

  const imgNote = fileList.length
    ? `\n\nARQUIVOS RECEBIDOS (${fileList.length}): Extraia APENAS valores claramente visÃ­veis. Nunca invente medidas.`
    : '';

  const sys =
`VocÃª Ã© o assistente de laudos do Dr. Roberto Freire Margotti (CRM-BA 26929 | RQE: 21367).

REGRAS ABSOLUTAS:
1. Retorne APENAS o texto do laudo. Sem explicaÃ§Ãµes, anÃ¡lises ou comentÃ¡rios.
2. NUNCA invente medidas â€” se nÃ£o foi fornecida, use "___".
3. NUNCA use dados de pacientes das referÃªncias â€” apenas o estilo e as frases.
4. Se hÃ¡ referÃªncias no banco: copie as frases EXATAS para os mesmos achados.
5. Mantenha o padrÃ£o exato da IMPRESSÃƒO DIAGNÃ“STICA das referÃªncias.
6. Assine: Dr. Roberto Freire Margotti | CRM-BA 26929 | RQE: 21367`;

  const userMsg =
    `EXAME: ${exam}\nDADOS DO PACIENTE: ${input || 'analisar pelos arquivos'}` +
    ragCtx +
    `\n\nTEMPLATE BASE (usar apenas se banco vazio):\n${TPL[exam] || ''}` +
    pStr + imgNote;

  return {sys, userMsg};
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CALL AI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function callAI(sys, userMsg) {
  const body = {system: sys, userMsg};
  if (fileList.length > 0) {
    body.images = fileList.map(f => ({name: f.name, base64: f.base64, type: f.type}));
  }
  const r = await fetch('/api/generate', {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify(body)
  });
  if (!r.ok) {
    const e = await r.json().catch(() => ({}));
    throw new Error(e.error || r.statusText);
  }
  const d = await r.json();
  if (!d.content) throw new Error('Resposta vazia do servidor');
  return d.content;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GERAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function generate() {
  const input = getInput();
  if (!input && !fileList.length) { toast('Insira os dados do exame', 'err'); return; }
  const btn = document.getElementById('gbtn');
  btn.disabled = true;
  btn.innerHTML = '<span class="dots"><span></span><span></span><span></span></span> Buscando...';
  try {
    const {sys, userMsg} = await buildPrompt(input, curExam);
    btn.innerHTML = '<span class="dots"><span></span><span></span><span></span></span> Gerando...';
    const content = await callAI(sys, userMsg);
    report = content;
    document.getElementById('lta').value = content;
    document.getElementById('lta').setAttribute('readonly', '');
    document.getElementById('lempty').style.display = 'none';
    document.getElementById('mlarea').style.display = 'none';
    document.getElementById('larea').style.display  = 'flex';
    toast('Laudo gerado!', 'ok');
    autoSave(curExam, content);
  } catch (e) {
    toast('Erro: ' + (e.message || 'Verifique a conexÃ£o'), 'err');
  } finally {
    btn.disabled = false;
    btn.innerHTML = 'âš¡ Gerar Laudo';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MULTI-LAUDO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function generateMulti() {
  const input = getInput();
  if (!input && !fileList.length) { toast('Insira os dados', 'err'); return; }
  const btn = document.getElementById('mbtn');
  btn.disabled = true;
  btn.innerHTML = '<span class="dots"><span></span><span></span><span></span></span> Detectando...';
  try {
    const detectSys = 'Classificador mÃ©dico. Responda APENAS com JSON array. Sem texto extra.';
    const detectMsg =
      `Quais exames ultrassonogrÃ¡ficos estÃ£o neste texto?\n` +
      `IDs vÃ¡lidos: obstetrico,abdome,endovaginal,tireoide,urinario,mamas,vascular,prostata,cervical,partes_moles,parede_abdominal\n` +
      `Texto: "${input}"\nResponda SOMENTE com o array. Ex: ["tireoide","mamas"]`;
    const savedFiles = fileList; fileList = [];
    const raw = await callAI(detectSys, detectMsg);
    fileList = savedFiles;
    const match = raw.match(/\[[\s\S]*?\]/);
    if (!match) throw new Error('NÃ£o foi possÃ­vel detectar os exames');
    const ids = JSON.parse(match[0]);
    if (!ids.length) { toast('Nenhum exame detectado', 'err'); return; }
    toast(`${ids.length} exame(s) detectado(s)`, 'inf');
    btn.innerHTML = `<span class="dots"><span></span><span></span><span></span></span> Gerando ${ids.length}...`;
    const results = await Promise.all(ids.map(async id => {
      const info = ALL_EXAMS.find(e => e.id === id) || {id, label:id, icon:'ğŸ“‹'};
      const {sys, userMsg} = await buildPrompt(input, id);
      const txt = await callAI(sys, userMsg);
      return {exam:id, label:info.label, icon:info.icon, text:txt};
    }));
    multiLaudos = results; multiActive = 0;
    document.getElementById('lempty').style.display = 'none';
    document.getElementById('larea').style.display  = 'none';
    document.getElementById('mlarea').style.display = 'flex';
    renderMLTabs();
    toast(`${multiLaudos.length} laudos gerados!`, 'ok');
    multiLaudos.forEach(l => autoSave(l.exam, l.text));
  } catch (e) {
    toast('Erro: ' + e.message, 'err');
  } finally {
    btn.disabled = false;
    btn.innerHTML = 'ğŸ§© Multi-Laudo';
  }
}

function renderMLTabs() {
  document.getElementById('mltabs').innerHTML = multiLaudos.map((l,i) =>
    `<button class="mltab${i===multiActive?' on':''}" onclick="switchML(${i})">${l.icon} ${l.label}</button>`
  ).join('');
  document.getElementById('mlta').value = multiLaudos[multiActive]?.text || '';
}
function switchML(i)  { multiActive = i; renderMLTabs(); }
function copyML()     { navigator.clipboard.writeText(multiLaudos[multiActive]?.text||''); toast('Copiado!','ok'); }
function pdfML()      { const l=multiLaudos[multiActive]; if(l) makePDF(l.label,l.exam,l.text); }
function saveAll()    { multiLaudos.forEach(l=>autoSave(l.exam,l.text)); toast(`${multiLaudos.length} salvos!`,'ok'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AÃ‡Ã•ES DO LAUDO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function copyL() { navigator.clipboard.writeText(document.getElementById('lta').value||report); toast('Copiado!','ok'); }
function editL() { document.getElementById('lta').removeAttribute('readonly'); document.getElementById('lta').focus(); toast('Modo ediÃ§Ã£o','inf'); }
function pdfL()  { const info=ALL_EXAMS.find(e=>e.id===curExam); makePDF(info?.label||curExam,curExam,document.getElementById('lta').value||report); }

// PDF COM CABEÃ‡ALHO PROFISSIONAL COMPLETO
function makePDF(label, examId, txt) {
  if (!txt) { toast('Nenhum laudo', 'err'); return; }
  const pac    = getPaciente();
  const dataBR = pac.data ? formatDataBR(pac.data) : new Date().toLocaleDateString('pt-BR');

  // CabeÃ§alho do paciente â€” sÃ³ mostra campos preenchidos
  const linhasPac = [];
  if (pac.nome)  linhasPac.push(`<div class="ph-row"><span class="ph-key">Paciente:</span><span class="ph-val">${pac.nome}</span></div>`);
  if (pac.data)  linhasPac.push(`<div class="ph-row"><span class="ph-key">Data do Exame:</span><span class="ph-val">${dataBR}</span></div>`);
  if (pac.idade) linhasPac.push(`<div class="ph-row"><span class="ph-key">Idade:</span><span class="ph-val">${pac.idade}</span></div>`);

  const pacBlock = linhasPac.length
    ? `<div class="pac-hdr">${linhasPac.join('')}</div>`
    : '';

  const nomeArq = pac.nome
    ? pac.nome.toLowerCase().replace(/\s+/g,'-')
    : examId;

  const html = `<!DOCTYPE html>
<html lang="pt-BR"><head><meta charset="UTF-8">
<title>Laudo â€” ${pac.nome || label}</title>
<style>
body{font-family:Georgia,serif;max-width:720px;margin:40px auto;padding:20px 40px;font-size:13px;line-height:1.9;color:#111}
.h{border-bottom:2px solid #111;padding-bottom:12px;margin-bottom:16px}
.h h1{font-size:13px;font-weight:700;margin:0 0 3px;text-transform:uppercase;letter-spacing:1px}
.h p{font-size:11px;color:#555;margin:0}
.pac-hdr{background:#f8f9fa;border:1px solid #dee2e6;border-radius:6px;
  padding:10px 14px;margin-bottom:18px;}
.ph-row{display:flex;gap:8px;margin-bottom:2px;}
.ph-row:last-child{margin-bottom:0;}
.ph-key{font-size:11px;font-weight:700;color:#555;min-width:110px;flex-shrink:0;}
.ph-val{font-size:12px;font-weight:600;color:#111;}
pre{white-space:pre-wrap;font-family:Georgia,serif;font-size:13px;}
.f{border-top:1px solid #ccc;margin-top:40px;padding-top:10px;font-size:10px;color:#999}
@media print{body{margin:20px 30px}}
</style></head><body>
<div class="h">
  <h1>${label}</h1>
  <p>Dr. Roberto Freire Margotti &middot; CRM-BA 26929 &middot; RQE: 21367 &middot; ${dataBR}</p>
</div>
${pacBlock}
<pre>${txt.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}</pre>
<div class="f">Margotti AI &middot; ${dataBR}</div>
</body></html>`;

  const a = Object.assign(document.createElement('a'), {
    href:     URL.createObjectURL(new Blob([html], {type:'text/html'})),
    download: `laudo-${nomeArq}-${Date.now()}.html`
  });
  a.click(); URL.revokeObjectURL(a.href);
  toast('Baixado! Abra e imprima como PDF', 'ok');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BANCO â€” IDÃŠNTICO AO MARGOTTI ORIGINAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadBanco() {
  try {
    const r = await fetch('/api/db?path=' +
      encodeURIComponent('/rest/v1/laudos?select=id,exam,classification,observation,report_text,created_at&order=created_at.desc&limit=200'));
    if (r.ok) {
      const data = await r.json();
      if (Array.isArray(data) && data.length) {
        banco = data.map(d => ({
          id:  d.id,
          exam: d.exam || '',
          cls:  d.classification || 'normal',
          obs:  d.observation || '',
          txt:  d.report_text || '',
          dt:   d.created_at ? new Date(d.created_at).toLocaleDateString('pt-BR') : ''
        }));
        localStorage.setItem('mb', JSON.stringify(banco));
      } else {
        banco = JSON.parse(localStorage.getItem('mb') || '[]');
      }
    } else {
      banco = JSON.parse(localStorage.getItem('mb') || '[]');
    }
  } catch {
    banco = JSON.parse(localStorage.getItem('mb') || '[]');
  }
  renderBanco();
}

function autoSave(examId, txt) {
  if (!txt || banco.find(b => b.txt === txt)) return;
  const item = {id:Date.now(), exam:examId, cls:'normal', obs:'', txt,
    dt:new Date().toLocaleDateString('pt-BR')};
  banco.unshift(item);
  localStorage.setItem('mb', JSON.stringify(banco));
  renderBanco();
  fetch('/api/db?path=' + encodeURIComponent('/rest/v1/laudos'), {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({exam:examId, exam_name:examId,
      classification:'normal', observation:'', report_text:txt})
  }).catch(() => {});
}

function toggleBanco() { document.getElementById('banco').classList.toggle('col'); }

function filtB(btn) {
  document.querySelectorAll('.bflt').forEach(b => b.classList.remove('on'));
  btn.classList.add('on');
  bfilt = btn.dataset.f;
  renderBanco();
}

function renderBanco() {
  const busca  = (document.getElementById('bsearch')?.value || '').toLowerCase().trim();
  let   lista  = bfilt === 'todos' ? banco : banco.filter(l => l.cls === bfilt);
  if (busca) {
    lista = lista.filter(l =>
      (l.obs||'').toLowerCase().includes(busca)  ||
      (l.exam||'').toLowerCase().includes(busca) ||
      (l.txt||'').toLowerCase().includes(busca));
  }
  document.getElementById('bct').textContent = banco.length;
  if (!lista.length) {
    document.getElementById('bcards').innerHTML =
      '<div class="bempty">Nenhum laudo encontrado.</div>'; return;
  }
  document.getElementById('bcards').innerHTML = lista.map(l => `
    <div class="lcard" onclick="viewL(${l.id})">
      <div class="lctop">
        <span class="tag ${l.cls==='normal'?'tn':'tp'}">${l.cls==='normal'?'âœ… Normal':'âš ï¸ Patol.'}</span>
        <span class="lcdt">${l.dt}</span>
      </div>
      <div class="lcex">${l.exam}</div>
      ${l.obs ? `<div class="lcobs">ğŸ“Œ ${l.obs}</div>` : ''}
      <div class="lcprev">${(l.txt||'').substring(0,120)}...</div>
      <div class="lcbtns">
        <button class="lcbtn" onclick="event.stopPropagation();viewL(${l.id})">Ver</button>
        <button class="lcbtn dl" onclick="event.stopPropagation();delL(${l.id})">Excluir</button>
      </div>
    </div>`).join('');
}

function viewL(id) {
  const l = banco.find(x => x.id === id);
  if (!l) return;
  report = l.txt;
  document.getElementById('lta').value = l.txt;
  document.getElementById('lta').setAttribute('readonly', '');
  document.getElementById('lempty').style.display = 'none';
  document.getElementById('mlarea').style.display = 'none';
  document.getElementById('larea').style.display  = 'flex';
  goTab('editor', document.querySelector('.ntab'));
  toast('Laudo carregado', 'inf');
}

function delL(id) {
  if (!confirm('Confirma exclusÃ£o do laudo?')) return;
  banco = banco.filter(l => l.id !== id);
  localStorage.setItem('mb', JSON.stringify(banco));
  renderBanco();
  toast('Removido', 'ok');
  fetch('/api/db?path=' + encodeURIComponent(`/rest/v1/laudos?id=eq.${id}`),
    {method:'DELETE'}).catch(() => {});
}

function doSave() {
  const cls = document.getElementById('scls').value;
  const obs = document.getElementById('sobs').value.trim();
  const txt = document.getElementById('lta').value || report;
  if (!txt) { toast('Nenhum laudo', 'err'); return; }
  const ex = banco.findIndex(l => l.txt === txt);
  if (ex >= 0) { banco[ex].cls = cls; banco[ex].obs = obs; }
  else banco.unshift({id:Date.now(), exam:curExam, cls, obs, txt,
    dt:new Date().toLocaleDateString('pt-BR')});
  localStorage.setItem('mb', JSON.stringify(banco));
  renderBanco();
  closeM('m-save');
  document.getElementById('sobs').value = '';
  toast('Salvo no banco!', 'ok');
  fetch('/api/db?path=' + encodeURIComponent('/rest/v1/laudos'), {
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({exam:curExam, exam_name:curExam,
      classification:cls, observation:obs, report_text:txt})
  }).catch(() => {});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DASHBOARD â€” usa banco existente, sem alterar DB
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDash() {
  const total = banco.length;
  const norm  = banco.filter(l => l.cls === 'normal').length;
  const pat   = banco.filter(l => l.cls === 'patologico').length;
  const tipos = new Set(banco.map(l => l.exam).filter(Boolean)).size;

  document.getElementById('d-total').textContent = total;
  document.getElementById('d-norm').textContent  = norm;
  document.getElementById('d-pat').textContent   = pat;
  document.getElementById('d-tipos').textContent = tipos;

  // Por exame
  const byExam = {};
  banco.forEach(l => { if (l.exam) byExam[l.exam] = (byExam[l.exam]||0)+1; });
  const examLabels = Object.keys(byExam).map(id => {
    const e = ALL_EXAMS.find(x => x.id === id);
    return e ? `${e.icon} ${e.label}` : id;
  });

  // Por mÃªs (Ãºltimos 6)
  const now = new Date();
  const months = Array.from({length:6},(_,i) => {
    const d = new Date(now.getFullYear(), now.getMonth()-5+i, 1);
    return {label:d.toLocaleDateString('pt-BR',{month:'short',year:'2-digit'}),
      y:d.getFullYear(), m:d.getMonth()};
  });
  const byMonth = months.map(({y,m}) =>
    banco.filter(l => {
      if (!l.dt) return false;
      const p = l.dt.split('/');
      return p.length===3 && parseInt(p[1])-1===m && parseInt('20'+p[2])===y;
    }).length
  );

  const CDEF = {
    responsive:true, maintainAspectRatio:false,
    plugins:{legend:{labels:{color:'#8098cc',font:{family:'Sora',size:11}}}},
    scales:{
      x:{ticks:{color:'#5a6e99',font:{family:'Sora',size:10}},grid:{color:'rgba(99,140,255,.07)'}},
      y:{ticks:{color:'#5a6e99',font:{family:'Sora',size:10}},grid:{color:'rgba(99,140,255,.07)'}}
    }
  };

  if (charts.donut) charts.donut.destroy();
  charts.donut = new Chart(document.getElementById('chartDonut'),{
    type:'doughnut',
    data:{labels:['Normais','PatolÃ³gicos'],
      datasets:[{data:[norm,pat],
        backgroundColor:['rgba(52,211,153,.7)','rgba(248,113,113,.7)'],
        borderColor:['#34d399','#f87171'],borderWidth:2}]},
    options:{responsive:true,maintainAspectRatio:false,
      plugins:{legend:{labels:{color:'#8098cc',font:{family:'Sora',size:11}}}}}
  });

  if (charts.line) charts.line.destroy();
  charts.line = new Chart(document.getElementById('chartLine'),{
    type:'line',
    data:{labels:months.map(m=>m.label),
      datasets:[{label:'Laudos',data:byMonth,
        borderColor:'#4f8ef7',backgroundColor:'rgba(79,142,247,.15)',
        tension:.4,pointBackgroundColor:'#4f8ef7',fill:true}]},
    options:{...CDEF,plugins:{legend:{display:false}}}
  });

  if (charts.bar) charts.bar.destroy();
  charts.bar = new Chart(document.getElementById('chartBar'),{
    type:'bar',
    data:{labels:examLabels,
      datasets:[{label:'Laudos',data:Object.values(byExam),
        backgroundColor:'rgba(79,142,247,.6)',borderColor:'#4f8ef7',
        borderWidth:1,borderRadius:5}]},
    options:{...CDEF,plugins:{legend:{display:false}},
      scales:{
        x:{ticks:{color:'#5a6e99',font:{family:'Sora',size:9}},grid:{color:'rgba(99,140,255,.07)'}},
        y:{ticks:{color:'#5a6e99',font:{family:'Sora',size:10}},grid:{color:'rgba(99,140,255,.07)'}}
      }}
  });

  // Ranking
  const sorted = Object.entries(byExam).sort((a,b)=>b[1]-a[1]);
  const maxv   = sorted[0]?.[1]||1;
  document.getElementById('toplist').innerHTML = sorted.slice(0,10).map(([id,ct]) => {
    const e = ALL_EXAMS.find(x=>x.id===id);
    return `<div class="top-item">
      <div class="top-lbl">${e?e.icon+' '+e.label:id}</div>
      <div class="top-bar-wrap"><div class="top-bar" style="width:${Math.round(ct/maxv*100)}%"></div></div>
      <div class="top-val">${ct}</div>
    </div>`;
  }).join('') || '<div style="color:var(--mut);font-size:12px">Nenhum dado ainda.</div>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INSTRUÃ‡Ã•ES â€” IDÃŠNTICO AO MARGOTTI ORIGINAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function unlock() {
  if (document.getElementById('pwdinp').value === 'margotti') {
    document.getElementById('lockform').style.display = 'none';
    document.getElementById('unlocked').style.display = '';
    toast('Desbloqueado!', 'ok');
  } else {
    toast('Senha incorreta', 'err');
    document.getElementById('pwdinp').value = '';
  }
}

async function addPrompt() {
  const e = document.getElementById('pexam').value;
  const t = document.getElementById('ptxt').value.trim();
  if (!t) { toast('Digite a instruÃ§Ã£o', 'err'); return; }
  try {
    const r = await fetch('/api/db?path=' + encodeURIComponent('/rest/v1/instrucoes'), {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({exam:e, texto:t})
    });
    const data = await r.json();
    const newId = Array.isArray(data) && data[0] ? data[0].id : Date.now();
    prompts.push({id:newId, exam:e, txt:t});
  } catch {
    prompts.push({id:Date.now(), exam:e, txt:t});
  }
  localStorage.setItem('mp', JSON.stringify(prompts));
  document.getElementById('ptxt').value = '';
  renderPrompts();
  toast('InstruÃ§Ã£o salva!', 'ok');
}

function delPrompt(id) {
  prompts = prompts.filter(p => p.id !== id);
  localStorage.setItem('mp', JSON.stringify(prompts));
  renderPrompts();
  fetch('/api/db?path=' + encodeURIComponent(`/rest/v1/instrucoes?id=eq.${id}`),
    {method:'DELETE'}).catch(() => {});
  toast('Removida', 'ok');
}

async function loadPrompts() {
  try {
    const r = await fetch('/api/db?path=' +
      encodeURIComponent('/rest/v1/instrucoes?select=*&order=created_at.asc'));
    if (r.ok) {
      const data = await r.json();
      if (Array.isArray(data) && data.length) {
        prompts = data.map(d => ({id:d.id, exam:d.exam, txt:d.texto}));
        localStorage.setItem('mp', JSON.stringify(prompts));
      } else {
        prompts = JSON.parse(localStorage.getItem('mp') || '[]');
      }
    } else {
      prompts = JSON.parse(localStorage.getItem('mp') || '[]');
    }
  } catch {
    prompts = JSON.parse(localStorage.getItem('mp') || '[]');
  }
  renderPrompts();
}

function renderPrompts() {
  const el = document.getElementById('pilist');
  if (!prompts.length) {
    el.innerHTML = '<div style="color:var(--mut);font-size:12px">Nenhuma instruÃ§Ã£o salva.</div>'; return;
  }
  el.innerHTML = prompts.map(p => `
    <div class="piitem">
      <div class="pitxt">${p.txt}</div>
      <span class="pitag">${p.exam}</span>
      <button class="pidel" onclick="delPrompt(${p.id})">âœ•</button>
    </div>`).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MODAIS & TOAST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openM(id)  { document.getElementById(id).classList.remove('off'); }
function closeM(id) { document.getElementById(id).classList.add('off'); }
document.querySelectorAll('.ov').forEach(o =>
  o.addEventListener('click', e => { if (e.target===o) o.classList.add('off'); }));

let toastTimer;
function toast(msg, type='inf') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className   = `toast show ${type}`;
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 3500);
}
</script>
</body>
</html>
